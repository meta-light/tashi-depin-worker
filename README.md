# tashi-depin-worker

Worker node software for Tashi's Decentralized Physical Infrastructure Network (DePIN).

## Features

* Claim license NFTs
* Connectivity tests

## Glossary

* `worker`: a DePIN worker node running on consumer or cloud hardware. Connects to, and is assigned work by, the `orchestrator`.
* `license`: an [ERC-721] non-fungible token representing the right to run a worker node.
    * May also be `delegated` to another address using [ERC-4907].
* `orchestrator`: the (for now) Tashi-hosted service that coordinates DePIN operations.
* `agent`: the component of the worker node that manages its DePIN operations.

[ERC-721]: https://eips.ethereum.org/EIPS/eip-721
[ERC-4907]: https://eips.ethereum.org/EIPS/eip-4907

## Requirements

### Platform

Currently only builds targeting Linux x86-64 are available. 

Windows x86-64 and Windows/Linux ARM64 builds will be available in the future.

* x86-64/AMD64 processor with Advanced Vector Extensions 2 (AVX-2)
* Linux kernel 3.2 or newer
* glibc version 2.17 or newer
* SSL root certificates (`ca-certificates` on Debian/Ubuntu)

Container images are also available based on `debian:bookworm-slim` which fulfill the software requirements.

### Resources: Bare Metal

#### Minimum specification

* x86-64 processor with Advanced Vector Extensions 2 (AVX-2)
    * Intel Haswell architecture or newer
    * AMD Excavator architecture or newer
* 2 GiB RAM
* Public IP address capable of accepting UDP traffic

### Resources: Container

These requirements only take into account the resoure requirements of `tashi-depin-worker` itself.

#### Note: Subject to Change

Resource requirements for the initial release are minimal. However, these may increase significantly in future releases. 

Check this page periodically for updated recommendations.

#### Minimum requests

* `cpu: 250m`
* `memory: 512Mi`

## Setup

### Get the Binary

`tashi-depin-worker` is available as a binary and a container image for x86-64 Linux.

Binary releases are available on the [Releases page](https://github.com/tashigg/tashi-depin-worker/releases).

Container images are available in the [GitHub Container Registry](https://github.com/orgs/tashigg/packages/container/package/tashi-depin-worker).

### Prepare a License Token

For initial testing, Tashi DePIN uses the following [ERC-721]/[ERC-4907] contract on Sepolia testnet:  
<https://sepolia.arbiscan.io/address/0x5537f3a83923d2533a2dfebae308707e7797ae1a>

License tokens may be claimed by a delegated user (`userOf()`, [ERC-4907]) or the owner if not delegated (`ownerOf()`, [ERC-721]).

* Create a wallet and save the private key seed (64-character hexadecimal string).
    * Optionally: create a second wallet to act as the user (delegate) of the license token. 
* Mint a license token to the wallet.
    * Partner note: minting is only allowed by the contract owner address. Contact us to get license tokens for testing.
* Optionally: execute `setUser()` ([ERC-4907]) for the token ID and the wallet address to delegate the license to. This will be the wallet that needs to be provided to `tashi-depin-worker`.

### Configuration

#### Required Arguments
`tashi-depin-worker` comes mostly pre-configured, but has some required arguments.

These arguments may be passed on the command line or via environment variable (names in parenthesis):

* `--license-token-id <token ID>` (`LICENSE_TOKEN_ID`): hexadecimal ID of the license NFT to claim.
* Private key to a wallet authorized to claim the license token, specified via **one of** the following (mutually exclusive):
    * `--license-key <private key seed>` (`LICENSE_KEY`): 64-character hexidecimal private key seed.
    * `--license-key-path <path>` (`LICENSE_KEY_PATH`): path to a file containing a PEM-encoded secp256k1 private key.
        * For use with private keys generated by other tools, such as OpenSSL.
        * Note: encrypted keystores ([Web3 Secret Storage](https://github.com/ethereum/wiki/wiki/Web3-Secret-Storage-Definition)) are not supported at this time.
    * The address corresponding to this key must be either the `ownerOf()` or `userOf()` for the given token ID. 
* `--agent-public-addr <IP:port>` (`AGENT_PUBLIC_ADDR`): public UDP socket address (`IP:port`) for DePIN agent operations; reported to the orchestrator.
    * Optional, but **should be set for proper operation**, especially if hosted behind NAT or a reverse proxy, such as a Kubernetes `NodePort` service.
    * If set, **must** be a UDP socket address that routes to the UDP socket bind address specified by `--agent-addr` (see below).
    * If not set, the worker node reports the value returned by `getsockname()` for the bound socket to the orchestrator, which may not be a valid or publicly routable destination address.
    * If the worker's agent is not reachable at this address, the worker will **not** be assigned work and thus will not be eligible for rewards.

#### Optional Arguments

`tashi-depin-worker` accepts additional arguments to tweak its behavior.

**Partner note**: it is recommended to leave these unspecified (and thus using their default values) unless otherwise instructed.

These arguments may also be passed on the command line or via environment variable (names in parenthesis):

* `--agent-addr <IP:port>` (`AGENT_ADDR`): UDP socket address (`IP:port`) to bind to for DePIN agent operations.
    * Default: `0.0.0.0:39065` -- binds to UDP port `39065` on any interface.
    * `--agent-public-addr` **should** be set, in addition to or instead of this flag, especially if the node is behind NAT or a reverse proxy.
* `--agent-key-path <path>` (`AGENT_KEY_PATH`): path to a file containing a PEM-encoded prime256v1 private key for DePIN agent operations.
    * Optional; may be set if a consistent identity for a given node is preferred.
    * If not set, a new, in-memory-only private key is generated from random entropy on startup.
    * To manually generate a private key: `openssl ecparam -name prime256v1 -genkey -noout -out <path>`
* `--orchestrator-url <url>` (`ORCHESTRATOR_URL`): override the URL used to connect to the DePIN orchestrator to receive work.
    * Default: `wss://orchestrator.depin.infra.tashi.dev`
    * Note: URL protocol **must** be either `ws://` (WebSockets) or `wss://` (secure WebSockets)
 
#### Enable Logging

Set the environment variable `RUST_LOG=tashi_depin_worker=info` for log printouts of the worker activity.

### Running

Other than the platform requirements listed above, `tashi-depin-worker` is a standalone binary. It may be run directly on bare metal, or as a container with the provided image.

Container users: forward UDP port `39065` out of the container, then set `--agent-public-addr` to the socket address `IP:port` where this port is forwarded to.

#### Startup Phase

On startup, `tashi-depin-worker` will:

* Bind a UDP socket to the address given by `--agent-addr` (or the default if not specified)
    * As discussed in [Configuration](#configuration), the worker node must be able to answer UDP traffic at this address in order to be assigned work and be eligible for rewards.
* Connect to the DePIN orchestrator at `--orchestrator-url` (or the default if not specified)
* Generate and sign a message claiming the license token and assigning it to the worker node for DePIN operations, identified by the worker's agent private key (`--agent-key-path` or randomly generated otherwise).
* Send the license claim to the Orchestrator.
    * Note: if a license token already in-use is claimed by another worker node, the worker previously using the license token is disconnected.
    * If the orchestrator rejects the license claim, `tashi-depin-worker` exits with a non-zero status code.
 
If all these steps succeed, the worker proceeds to the idle phase.

##### Log Example

If you set the `RUST_LOG` variable as above, you should see log output like this (in this example, configuration parameters are passed by environment variable):

```
$ ./tashi-depin-worker 
2024-10-04T04:46:01.384144Z  INFO tashi_depin_worker: starting node agent public_key=f45883ed870932152925857974ee5035457006e27304900df4a92e16a991c5d022f5147ba6693421ed
2024-10-04T04:46:01.385594Z  INFO tashi_depin_worker: connecting to orchestrator orchestrator_url=wss://orchestrator.depin.infra.tashi.dev/v1/node/ws
2024-10-04T04:46:02.277589Z  INFO tashi_depin_worker: License claim successful
```

#### Idle Phase

For workers not otherwise assigned work, the DePIN Orchestrator will select pairs at random and ask them to perform connectivity checks for each other.

These connectivity checks not only ensure that the workers are reachable on the public Internet, but also measure their inbound and outbound bandwidth to estimate their capacity.

Workers that repeatedly fail connectivity tests are not assigned paying work.

##### Log Example

If you set the `RUST_LOG` variable as above, after a few minutes you should see additional log output like this (in this example, configuration parameters are passed by environment variable):

```
2024-10-04T04:47:38.320837Z  INFO run_client{test_id=0dd633ab-9dc1-43a6-85a1-649aed807042 peer_addr=67.182.3.12:39065 duration_seconds=120}: tashi_depin_worker::agent::speed_test: starting speed test
2024-10-04T04:49:39.373626Z  INFO run_client{test_id=0dd633ab-9dc1-43a6-85a1-649aed807042 peer_addr=67.182.3.12:39065 duration_seconds=120}: tashi_depin_worker::agent::speed_test: speed test complete bytes_transferred=3443326976 transfer_time=121.052749921s round_trip_time=30.884818ms
```

This shows a peer that was chosen to be the "client" for a speed test. It connects to the peer at `peer_addr` and forwards a signed authorization from the orchestrator for the speed test (to prevent DoS attacks). The "server" peer starts generating random data and sending it to the client peer for the duration of the test.

At the conclusion of the test, the agent reports the number of bytes transferred, the total time, and the round-trip latency for the connection.

Here is the logs from the server peer for the same test:

```
2024-10-04T04:47:38.323736Z  INFO run_server{peer_addr=67.182.3.12:39066}: tashi_depin_worker::agent::speed_test: starting speed test test_id=6299d77b-ec3b-405d-a475-b0e6c3444cc1 duration_seconds=120
2024-10-04T04:49:38.370775Z  INFO run_server{peer_addr=67.182.3.12:39066}: tashi_depin_worker::agent::speed_test: speed test complete bytes_transferred=3443326976 transfer_time=120.046990695s round_trip_time=22.237167ms
```

To avoid loading the worker nodes for overly long, speed tests only happen in one direction at a time. The orchestrator will wait a period of time before issuing another test for the same peer.

#### Working Phase (TBD)

## NOTICE
### 1. License Grant

This software is provided free of charge exclusively for use with the Tashi decentralized physical infrastructure network (DePIN). By using this software, you agree to use it solely to support Tashi’s DePIN. Any other use, including but not limited to personal, commercial, or competitive purposes, requires a separate license agreement with Tashi Network Pte Ltd.

### 2. Restrictions

You may not disassemble, decompile, reverse engineer, modify, redistribute, repackage, sublicense, or resell this software, in whole or in part, except as expressly permitted in writing by Tashi Network Pte Ltd.

### 3. Ownership

All rights, title, and interest in and to this software, including any modifications or derivatives, are and shall remain the exclusive property of Tashi Network Pte Ltd. No rights are granted by implication, estoppel, or otherwise.

### 4. Disclaimer of Warranties

This software and any accompanying documentation are provided “AS IS” without any warranties, express or implied, including, but not limited to, the implied warranties of merchantability, fitness for a particular purpose, and non-infringement. Tashi Network Pte Ltd does not warrant that the software will meet your requirements or operate without interruption or error.

### 5. Limitation of Liability

To the maximum extent permitted by applicable law, in no event shall Tashi Network Pte Ltd be liable for any direct, indirect, incidental, special, consequential, or punitive damages arising out of or related to your use or inability to use the software, even if Tashi Network Pte Ltd has been advised of the possibility of such damages.

### 6. Acceptance of Risk
By using this software, you accept and assume all risks associated with its use, including but not limited to potential data loss, system errors, or other performance issues.
